<body style="margin: 0;">
    <script>
        const canvas = document.createElement('canvas')
        canvas.width = window.innerWidth
        canvas.height = window.innerHeight
        document.body.append(canvas)
        const ctx = canvas.getContext('2d')
        ctx.fillStyle = "#ffffff"

        function clear() {
            ctx.resetTransform()
            ctx.fillRect(0, 0, canvas.width, canvas.height)
            ctx.translate(canvas.width / 2, canvas.height / 2)
            ctx.scale(1, -1)
        }

        function drawCircle(p, r) {
            ctx.beginPath()
            ctx.arc(p[0], p[1], r, 0, 2 * Math.PI)
            ctx.stroke()
        }

        function drawBox(p, s) {
            ctx.beginPath()
            ctx.rect(p[0] - s[0], p[1] - s[1], s[0] * 2, s[1] * 2)
            ctx.stroke()
        }

        function drawLine(a, b) {
            ctx.beginPath()
            ctx.moveTo(a[0], a[1])
            ctx.lineTo(b[0], b[1])
            ctx.stroke()
        }

        const mp = [0, 0]

        window.addEventListener('mousemove', e => {
            mp[0] = e.clientX - canvas.width / 2
            mp[1] = -(e.clientY - canvas.height / 2)
        })

        const circle1= {
            p: [-100, -100],
            r: 30
        }

        const circle2 = {
            p: [-100, 100],
            r: 60
        }

        const box1 = {
            p: [100, 100],
            s: [30, 60]
        }

        const box2 = {
            p: [100, -100],
            s: [60, 60]
        }

        function length(v) {
            return Math.sqrt(v[0] ** 2 + v[1] ** 2)
        }

        function sdCircle(p, r) {
            return length(p) - r
        }

        function abs(v) {
            return [Math.abs(v[0]), Math.abs(v[1])]
        }

        function max(v, s) {
            return [Math.max(v[0], s), Math.max(v[1], s)]
        }

        function subtract(a, b) {
            return [a[0] - b[0], a[1] - b[1]]
        }

        function sdBox(p, s) {
            const d = subtract(abs(p), s)

            return length(max(d, 0)) + Math.min(Math.max(d[0], d[1]), 0)
        }

        function map(p) {
            const c1 = sdCircle(subtract(p, circle1.p), circle1.r)
            const c2 = sdCircle(subtract(p, circle2.p), circle2.r)
            const b1 = sdBox(subtract(p, box1.p), box1.s)
            const b2 = sdBox(subtract(p, box2.p), box2.s)

            return Math.min(c1, c2, b1, b2)
        }

        const p = mp
        const r = 30

        const downscaling = 100
        const subdivision = 100
        const rDownscaled = r / downscaling

        function calcQuadrant(p) {
            const dx1 = map(subtract(p, [-1, 0]))
            const dx2 = map(subtract(p, [1, 0]))
            const dy1 = map(subtract(p, [0, -1]))
            const dy2 = map(subtract(p, [0, 1]))
            const dxm = dx1 < dx2 ? -1 : 1
            const dym = dy1 < dy2 ? -1 : 1

            return [-dxm, -dym]
        }

        function draw() {
            const quadrant = calcQuadrant(p)
            const qx = [p[0] + quadrant[0] * rDownscaled, p[1]]
            const qy = [p[0], p[1] + quadrant[1] * rDownscaled]
            const d0 = map(p) - r

            clear()
            drawCircle(circle1.p, circle1.r)
            drawCircle(circle2.p, circle2.r)
            drawBox(box1.p, box1.s)
            drawBox(box2.p, box2.s)

            if (d0 < 0) {
                const d1 = map(qx)
                const d2 = map(qy)
                let nearDir = d1 < d2 ? [quadrant[0], 0] : [0, quadrant[1]]
                let minDist = d1 < d2 ? d1 : d2

                for (let a = 1; a < subdivision; ++a) {
                    const angle = (Math.atan2(quadrant[0], quadrant[1]) * 180 / Math.PI) - 45 + 90 / subdivision * a
                    const dirUnit = [Math.sin(angle * Math.PI / 180), Math.cos(angle * Math.PI / 180)]
                    const dir = [p[0] + dirUnit[0] * rDownscaled, p[1] + dirUnit[1] * rDownscaled]
                    const dist = map(dir)

                    if (dist < minDist) {
                        nearDir = dirUnit
                        minDist = dist
                    }
                }

                ctx.strokeStyle = "#ff0000"
                drawCircle([p[0] + nearDir[0] * d0, p[1] + nearDir[1] * d0], r)
            } else {
                ctx.strokeStyle = "#000000"
                drawCircle(p, r)
            }

            requestAnimationFrame(draw)
        }

        draw()

    </script>
</body>
